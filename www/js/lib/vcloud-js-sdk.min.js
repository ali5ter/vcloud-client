/*
 VMware Cloud Director JavaScript SDK Library

 Copyright (c) 2012 VMware, Inc. All rights reserved.

*/
var vmware="undefined"==typeof vmware||!vmware?{}:vmware;vmware.events="undefined"==typeof vmware.events||!vmware.events?{}:vmware.events;var global,global2,imageData;vmware.cloudVersion={V1_0:"1.0",V1_5:"1.5",V5_1:"5.1"};var connectivity=1;
vmware.events.cloud={INITIALIZATION_COMPLETE:"event.cloud.initialization.complete",LOGIN:"event.cloud.login",TASK_START:"event.cloud.task.start.",TASK_COMPLETE:"event.cloud.task.complete.",REFRESH_COMPLETE:"event.cloud.refresh.complete",REFRESH_SINGLE:"event.cloud.refresh.single",TEMPLATE_REFRESH:"event.cloud.template.refresh",SEARCH_COMPLETE:"event.cloud.search.complete",PROGRESS_UPDATE:"event.cloud.progress.update",NEW_TICKET:"event.cloud.ticket.new",ERROR:"event.cloud.error",TEMPLATE_FILLED:"event.cloud.template.filled."};
vmware.cloud=function(a,f){var g="";vmware.rest.get(a.concat("versions")).done(function(b){$(b).find("VersionInfo").each(function(){$(this).find("Version").text()==f&&(g=$(this).find("LoginUrl").text(),d.trigger(vmware.events.cloud.INITIALIZATION_COMPLETE))});""==g&&d.trigger(vmware.events.cloud.ERROR,localizer.get("SYSTEM_NOT_SUPPORTED"))}).error(function(){d.trigger(vmware.events.cloud.ERROR,localizer.get("SYSTEM_NOT_SUPPORTED"))});var i={vapps:{},vms:{}},j={vapps:{},vms:{}},h=[],n={},e={},d=vmware.eventManager({});
d.base=a;d.login=function(b,l,k){$.base64.encode(b+"@"+k+":"+l);vmware.rest.addHeader("Authorization","Basic "+$.base64.encode(b+"@"+k+":"+l));vmware.rest.addHeader("Accept","application/*+xml;version=5.1");vmware.rest.post(g).done(function(b){var b={success:!0,data:$.parseXML(b.xml?b.xml:(new XMLSerializer).serializeToString(b))},l=b.data.childNodes[0].getAttribute("user"),k=b.data.childNodes[0].getAttribute("org"),e=$(b.data).find('Link[href*="/api/admin"]').attr("href"),a=$(b.data).find('Link[name="'+
k+'"]').attr("href");d.user=new z(l,k,a,e);d.begin();d.trigger(vmware.events.cloud.LOGIN,b)}).fail(function(b){d.trigger(vmware.events.cloud.LOGIN,{success:!1,data:b.statusText})})};d.confirmLoggedIn=function(){vmware.rest.addHeader("Accept","application/*+xml;version=5.1");vmware.rest.get(a.concat("session")).done(function(b){var b={success:!0,confirm:!0,data:$.parseXML(b.xml?b.xml:(new XMLSerializer).serializeToString(b))},l=b.data.childNodes[0].getAttribute("user"),k=b.data.childNodes[0].getAttribute("org"),
e=$(b.data).find('Link[href*="/api/admin"]').attr("href"),a=$(b.data).find('Link[name="'+k+'"]').attr("href");d.user=new z(l,k,a,e);d.begin();d.trigger(vmware.events.cloud.LOGIN,b)}).fail(function(b){d.trigger(vmware.events.cloud.LOGIN,{success:!1,confirm:!0,data:b.statusText})})};d.fetchURL=function(b,l,k,e,a){var g=function(b){null!=e&&e($.parseXML(b.xml?b.xml:(new XMLSerializer).serializeToString(b)))};vmware.rest.removeAllHeaders();k?vmware.rest.addHeader("Accept",k):vmware.rest.addHeader("Accept",
"application/*+xml;version=5.1");"GET"==l||null==l?vmware.rest.get(b).done(function(b){connectivity=1;g(b)}).fail(function(b){connectivity&&(console.warn("Fetch error: "+b.statusText),connectivity=0,d.trigger(vmware.events.cloud.ERROR,localizer.get("LOST_CONNECTIVITY")))}):"POST"==l?vmware.rest.post(b).done(function(b){g(b)}).fail(function(b){console.warn("Post error: "+b.statusText)}):"DELETE"==l?vmware.rest.del(b).done(function(b){g(b)}).fail(function(b){console.warn("Delete error: "+b.statusText)}):
"SOAP"==l&&(vmware.soap.addHeader("Content-Type","text/xml; charset=utf-8"),vmware.soap.addHeader("SOAPAction","urn:vim25/4.1"),vmware.soap.post(b,a).done(function(b){g(b)}).fail(function(b,d){console.warn("SOAP error: "+d)}))};var o=function(b){if(!1==p.comissioning)if(setTimeout(function(){p.comissioning=!1},3E4),p.comissioning=!0,b=b.getElementsByTagName("VAppRecord"),0!=b.length){j.vapps={};j.vms={};for(var l,k=0;k<b.length;k++)if("VAppRecord"==b[k].nodeName){l=new vApp(d);for(var e=0;e<b[k].attributes.length;e++)l.setAttr(b[k].attributes[e].name,
b[k].attributes[e].value);d.fetchURL(b[k].getAttribute("href"),null,null,A(l))}}else d.trigger(vmware.events.cloud.REFRESH_COMPLETE,!1),p.comissioning=!1},p=this,r=this.comissioning=!1,s=0,q=0,B=function(b){0!=q&&(d.trigger(vmware.events.cloud.PROGRESS_UPDATE,d.percentageDoneUpdate()),s++,s==q&&(q=s=0,!1==r&&(i=j),j={vapps:[],vms:[]},p.comissioning=!1,!0==r?d.trigger(vmware.events.cloud.REFRESH_SINGLE,{vapp:b}):d.trigger(vmware.events.cloud.REFRESH_COMPLETE,!0),r=!1))},F=function(b){q=0;for(var b=
b.getElementsByTagName("VMRecord"),l=0;l<b.length;l++)"UNRESOLVED"!=b[l].getAttribute("status")&&"false"==b[l].getAttribute("isVAppTemplate")&&q++;d.fetchURL(a.concat("query?type=vApp&format=records&pageSize=1024"),"GET",null,o)},A=function(b){return function(l){var k=namespacex="";null!=l.childNodes[0].getAttribute("xmlns:vcloud")&&(k="vcloud",namespacex=k+":");k=""==k?function(b){return l.getElementsByTagName(b)}:function(b){return l.getElementsByTagNameNS(l.childNodes[0].getAttribute("xmlns:vcloud"),
b)};if(l.childNodes[0].nodeName==namespacex+"VApp"){var e=k("Description")[0].childNodes;e&&e.length&&b.setAttr("description",e[0].nodeValue);for(e=0;e<l.childNodes[0].attributes.length;e++)b.setAttr(l.childNodes[0].attributes[e].name,l.childNodes[0].attributes[e].value);(e=k("DateCreated")[0].childNodes)&&e.length&&b.setAttr("creationDate",e[0].nodeValue);(e=k("Owner")[0].childNodes)&&e.length&&b.setAttr("ownerName",e[1].getAttribute("name"));r?i.vapps[b.getID()]=b:j.vapps[b.getID()]=b;for(var e=
k("Link"),a=0;a<e.length;a++)l.childNodes[0].nodeName==e[a].parentNode.nodeName&&b.addLink(e[a].getAttribute("rel"),e[a].getAttribute("href"));b.setAttr("searchTerm","name:"+b.getName()+"owner:"+b.getOwnerName()+"status:"+b.getStatusMessage()+"description:"+b.getDescription());b.setAttr("searchTerm",b.getAttr("searchTerm").toLowerCase());b.children=[];var g=k("Vm");r&&(q=g.length);for(a=0;a<g.length;a++){getTag=function(b){return g[a].getElementsByTagName(b)};for(var h=new vM(d),e=0;e<g[a].attributes.length;e++)h.setAttr(g[a].attributes[e].name,
g[a].attributes[e].value);null!=getTag("IpAddress")[0]&&h.setAttr("ip",getTag("IpAddress")[0].childNodes[0].nodeValue);null!=l.getElementsByTagNameNS("http://schemas.dmtf.org/ovf/envelope/1","Description")[0]&&h.setAttr("guestOS",g[a].getElementsByTagNameNS("http://schemas.dmtf.org/ovf/envelope/1","Description")[0].childNodes[0].nodeValue);null!=k("NetworkConnection")[0]&&h.setAttr("network",getTag("NetworkConnection")[0].getAttribute("network"));(e=getTag("Description")[0].childNodes)&&e.length&&
h.setAttr("description",e[0].nodeValue);for(var e=k("Link"),f=0;f<e.length;f++)g[a].nodeName==e[f].parentNode.nodeName&&h.addLink(e[f].getAttribute("rel"),e[f].getAttribute("href"));h.updateConsoleThumbnail();b.children.push(h.getID());r?(i.vms[h.getID()]=h,B(b)):(j.vms[h.getID()]=h,B())}}}},u=function(b,e){if(null!=d.getVM(b))d.fetchURL(d.getVM(b).links[e],"POST",null,d.taskManager.newTask);else if(null!=d.getVApp(b)){d.taskManager.addFakeTask(d.getVApp(b).getHref());if("power:powerOff"==e)return vmware.rest.addHeader("Content-Type",
"application/vnd.vmware.vcloud.undeployVAppParams+xml"),xml='<?xml version="1.0" encoding="UTF-8"?>                    <UndeployVAppParams                       xmlns="http://www.vmware.com/vcloud/v1.5">                       <UndeployPowerAction>powerOff</UndeployPowerAction>                    </UndeployVAppParams>',vmware.rest.post(d.getVApp(b).links.undeploy,xml).done(function(b){d.taskManager.newTask($.parseXML(b.xml?b.xml:(new XMLSerializer).serializeToString(b)))}),!0;"remove"==e?d.fetchURL(d.getVApp(b).links[e],
"DELETE",null,d.taskManager.newTask):d.fetchURL(d.getVApp(b).links[e],"POST",null,d.taskManager.newTask)}else{var k;k=a.concat("vApp/"+b.split(":")[b.split(":").length-2]+"-"+b.split(":")[b.split(":").length-1]);k="power"==e.split(":")[0]?k+"/power/action/"+e.split(":")[1]:k+"/action/"+e;d.fetchURL(k,"POST",null,d.taskManager.newTask)}},w={ownerName:"owner",memoryAllocationMB:"memory",catalogName:"catalog",storageKB:"storage",cpuAllocationMhz:"cpu"},x=function(b,e,a){return function(g){var f=g.getElementsByTagName("VAppTemplateRecord");
if(0!=f.length)for(var i,j=0;j<f.length;j++){i=new Template;for(var o=0;o<f[j].attributes.length;o++)i.setAttr(w[f[j].attributes[o].name]?w[f[j].attributes[o].name]:f[j].attributes[o].name,f[j].attributes[o].value),i.setAttr("searchTerm",i.getAttr("searchTerm")+(w[f[j].attributes[o].name]?w[f[j].attributes[o].name]:f[j].attributes[o].name)+":"+f[j].attributes[o].value);h[(b-1)*e+j]=i}if(a){g=g.getElementsByTagName("Link");for(j=0;j<g.length;j++)if("nextPage"==g[j].getAttribute("rel")){d.fetchURL(g[j].getAttribute("href"),
"GET",null,x(b+1,128,!0));return}y=!0}d.trigger(vmware.events.cloud.TEMPLATE_REFRESH,h)}};d.user=null;var z=function(b,d,e,a){return{getName:function(){return b},getOrg:function(){return d},getAdminUrl:function(){return a},getOrgUrl:function(){return e}}};d.getUserName=function(){return this.user.getName()};d.getUserOrg=function(){return this.user.getOrg()};d.getAdminUrl=function(){return this.user.getAdminUrl()};d.getUserOrgUrl=function(){return this.user.getOrgUrl()};d.fleshOutTemplate=function(b){null==
b.getAttr("childNames")?d.fetchURL(b.getHref(),"GET",null,C(b)):cloud.trigger(vmware.events.cloud.TEMPLATE_FILLED+b.getHref(),b)};d.fleshOutMultiple=function(b){for(var e=b.length,a=0,g=0;g<e;g++)templ=b[g],cloud.once(vmware.events.cloud.TEMPLATE_FILLED+templ.getHref(),function(){a++;a==e&&cloud.trigger(vmware.events.cloud.TEMPLATE_FILLED)}),d.fetchURL(templ.getHref(),"GET",null,C(templ))};var C=function(b){return function(d){null!=d.getElementsByTagName("Description")[0].childNodes[0]&&b.setAttr("description",
d.getElementsByTagName("Description")[0].childNodes[0].nodeValue);null!=d.getElementsByTagName("NetworkConfig")[0]&&b.setAttr("network",d.getElementsByTagName("NetworkConfig")[0].getAttribute("networkName"));b.setAttr("childNames",[]);for(var e=0;e<d.getElementsByTagName("Vm").length;e++)b.setAttr("childNames",b.getAttr("childNames").concat(d.getElementsByTagName("Vm")[e].getAttribute("name")));cloud.trigger(vmware.events.cloud.TEMPLATE_FILLED+b.getHref(),b)}};d.getAllTemplates=function(){d.fetchURL(a.concat("query?type=vAppTemplate&format=records&page=1&pageSize=128"),
"GET",null,x(1,128,!0))};var D=function(b,e,g){d.fetchURL(a.concat("query?type="+b+"&format=records"),"GET",null,G(e,g))},G=function(b,d){return function(e){for(var e=e.getElementsByTagName(b),a=0;a<e.length;a++)-1!=e[a].getAttribute("linkType")&&(d[e[a].getAttribute("name")]=e[a].getAttribute("href"))}};d.metrics=function(){m={totalStorage:0,totalMemory:0,totalRunning:0,totalStopped:0,totalSuspended:0,totalError:0,tasksPerHour:0};temp=d.getVApps(d.SORTBY.DATE);for(var b=0;b<temp.length;b++){switch(temp[b].getStatus()){case temp[b].STATUS_OFF:m.totalStopped++;
break;case temp[b].STATUS_SUSPENDED:m.totalSuspended++;break;case temp[b].STATUS_ERROR:m.totalError++;break;default:m.totalRunning++}m.totalStorage+=parseInt(temp[b].getAttr("storageKB"))/1E3;m.totalMemory+=parseInt(temp[b].getAttr("memoryAllocationMB"))}m.tasksPerHour=Math.ceil(d.taskManager.tasksPerHour());return m};var y=!1,E=function(b){return function(){global=b;y=!0;for(var e=[],a,g=0;g<h.length;g++)if(a=!0,h[g]){for(var f in b)if(b[f].match("-")){if(terms=b[f].split("-"),!(""==terms[0].replace(" ",
"").replace(",","")||parseInt(terms[0].replace(" ","").replace(",",""))<=parseInt(h[g].getAttr(f)))||!(""==terms[1].replace(" ","").replace(",","")||parseInt(terms[1].replace(" ","").replace(",",""))>=parseInt(h[g].getAttr(f)))){a=!1;break}}else for(var i=0;i<b[f].split(" ").length;i++)if(""!=b[f].split(" ")[i]&&(null==h[g].getAttr(f)||null==h[g].getAttr(f).toLowerCase().match(b[f].split(" ")[i].toLowerCase()))){a=!1;break}a&&e.push(h[g])}d.trigger(vmware.events.cloud.SEARCH_COMPLETE,e)}};d.getNetworks=
function(){names=[];for(var b in n)names.push(b);return names};d.getVdcList=function(){names=[];for(var b in e)names.push(b);return names};d.editVApp=function(b,e,a){e='<?xml version="1.0" encoding="UTF-8" standalone="no"?>                        <vcloud:VApp                            xmlns:vcloud="http://www.vmware.com/vcloud/v1.5"                            name="'+(e||d.getVApp(b).getName())+'">                            <vcloud:Description>'+(a||d.getVApp(b).getDescription())+"</vcloud:Description>                    </vcloud:VApp>";
vmware.rest.addHeader("Content-Type","application/vnd.vmware.vcloud.vApp+xml");vmware.rest.put(d.getVApp(b).getHref(),e).done(function(b){d.taskManager.newTask($.parseXML(b.xml?b.xml:(new XMLSerializer).serializeToString(b)))})};d.instantiateVApp=function(b,a,g,f,h,i){templateObj=d.getTemplateFromHref(h);if(!e[g]||!templateObj)return!1;d.once(vmware.events.cloud.TEMPLATE_FILLED+h,function(j){networkName=j.eventData.getNetwork();f=n[f]?f:n[0];j=instantTempParams(b,a,networkName,n[f],h,i);vmware.rest.addHeader("Content-Type",
"application/vnd.vmware.vcloud.instantiateVAppTemplateParams+xml");vmware.rest.post(e[g]+"/action/instantiateVAppTemplate",j).done(function(b){d.once(vmware.events.cloud.TASK_START,d.updateModels);d.taskManager.newTask($.parseXML(b.xml?b.xml:(new XMLSerializer).serializeToString(b)))})});d.fleshOutTemplate(templateObj);return!0};d.searchCatalogFaceted=function(b){y?E(b)():(d.once(vmware.events.cloud.TEMPLATE_REFRESH,E(b)),d.getAllTemplates())};d.searchCatalog=function(b){d.searchCatalogFaceted({searchTerm:b})};
d.taskHistory=function(){return d.taskManager.taskLog()};d.updateModels=function(){d.fetchURL(a.concat("query?type=vm&format=records&pageSize=1024"),"GET",null,F)};d.begin=function(){d.metadata=new Metadata(a);d.taskManager=new TaskManager(d);d.register(vmware.events.cloud.TASK_COMPLETE,d.updateSingle);D("orgVdcNetwork","OrgVdcNetworkRecord",n);D("orgVdc","OrgVdcRecord",e);d.taskManager.autoRefresh=function(b){d.fetchURL(a.concat("query?type=task&filter=(status==running)"),"GET",null,b)};d.fetchURL(a.concat("query?type=task&pageSize=15&sortDesc=startDate"),
"GET",null,d.taskManager.loadTasksLog);d.updateModels();d.getAllTemplates();d.once(vmware.events.cloud.TEMPLATE_REFRESH,function(){d.metadata.register(d.metadata.filterTemplates("downloads"),function(b){for(t in b)d.getTemplateFromHref(t).setAttr("downloads",b[t])})})};d.updateSingle=function(b){b=b.eventData.data;r=!0;d.fetchURL(b.attr.ownerHref,"GET",null,A(d.getVAppFromHref(b.attr.ownerHref)||new vApp(d),!0))};d.updateCatalog=function(b,e){for(var g=(b-1)*e;g<b*e;g++)if(null==h[g])return d.fetchURL(a.concat("query?type=vAppTemplate&format=records&page="+
b+"&pageSize="+e),"GET",null,x(b,e,!1));d.trigger(vmware.events.cloud.TEMPLATE_REFRESH,h)};d.getCatalog=function(){return h};d.getVMStatus=function(b){for(var e=d.taskManager.inProgress(),a=0;a<e.length;a++)if(null!=b.getID().match(e[a]))return b.STATUS_WORKING;return b.getStatus()};d.percentageDoneUpdate=function(){return 0!=q?100*s/q:0};d.getVApps=function(b){list=[];for(var e in i.vapps)list.push(i.vapps[e]);if(null!=b){switch(b){case d.SORTBY.NAME:sorter=function(b,d){return b.getName()>d.getName()};
break;case d.SORTBY.DATE:sorter=function(b,d){return b.getCreationDate()>d.getCreationDate()}}return list.sort(sorter)}return list};d.SORTBY={NAME:0,DATE:1};d.getVMs=function(){list=[];for(var b in i.vms)list.push(i.vms[b]);return list};d.getVM=function(b){return i.vms[b]};d.getVApp=function(b){return i.vapps[b]};d.getVObject=function(b){return d.getVApp(b)||d.getVM(b)};d.getVAppFromHref=function(b){for(var d in i.vapps)if(i.vapps[d].getAttr("href")==b)return i.vapps[d]};d.getTemplateFromHref=function(b){for(var d in h)if(h[d].getAttr("href")==
b)return h[d]};d.powerOff=function(b){u(b,"power:powerOff")};d.powerOn=function(b){u(b,"power:powerOn")};d.suspend=function(b){u(b,"power:suspend")};d.deleteVApp=function(b){u(b,"remove")};d.displayConsole=function(b,d){cloud.once(vmware.events.cloud.NEW_TICKET,function(){});d.getConsoleTicket()};d.saveCache=function(){for(var b={vapps:[]},e=d.getVApps(),a=0;a<e.length;a++)b.vapps.push(e[a].save());b.vms=[];e=d.getVMs();for(a=0;a<e.length;a++)b.vms.push(e[a].save());b.catalog=[];e=d.getCatalog();
for(a=0;a<e.length;a++)b.catalog.push(e[a].save());b.tasks=d.taskManager.saveLog();return JSON.stringify(b)};d.loadCache=function(b){b=JSON.parse(b);i={vapps:{},vms:{}};h=[];for(var e,a=0;a<b.vapps.length;a++)e=new vApp(d),e.load(b.vapps[a]),i.vapps[e.getID()]=e;for(a=0;a<b.vms.length;a++)e=new vM(d),e.load(b.vms[a]),i.vms[e.getID()]=e;for(a=0;a<b.catalog.length;a++)e=new Template,e.load(b.catalog[a]),h.push(e);d.taskManager.loadLog(b.tasks);d.trigger(vmware.events.cloud.REFRESH_COMPLETE)};return d};vmware="undefined"==typeof vmware||!vmware?{}:vmware;vmware.events.log=[];
vmware.eventManager=function(a){var f={};a.register=function(a,i,j){vmware.events.log.push("Registering "+String(i).split(" ")[1]+" with "+a);i={method:i,handlerData:j};f.hasOwnProperty(a)?f[a].push(i):f[a]=[i]};a.unregister=function(a,i){vmware.events.log.push("Unregistering "+String(i).split(" ")[1]+" with "+a);for(var j=f[a].length-1;0<=j;j--)f[a][j].method===i&&f[a].splice(j,1)};a.trigger=function(a,i){if(f.hasOwnProperty(a)){var j=f[a];vmware.events.log.push("Triggering "+a+", "+j.length+" registered.");
for(var h=0;h<j.length;h+=1){var n=j[h];n.method.apply(this,[{key:a,handlerData:n.handlerData,eventData:i}])}}};a.once=function(g,f,j){var h=function(j){f(j);a.unregister(g,h)};a.register(g,h,j)};return a};var instantTempParams=function(a,f,g,i,j,h){return"<?xml version='1.0' encoding='UTF-8'?>    <InstantiateVAppTemplateParams       xmlns='http://www.vmware.com/vcloud/v1.5'       name='"+a+"'       deploy='"+(null==h?!1:h)+"'       powerOn='"+(null==h?!1:h)+"'       xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'       xmlns:ovf='http://schemas.dmtf.org/ovf/envelope/1'>       <Description>"+f+"</Description>       <InstantiationParams>"+(i?"          <NetworkConfigSection>             <ovf:Info>Configuration parameters for logical networks             </ovf:Info>             <NetworkConfig                networkName='"+
g+"'>                <Configuration>                   <ParentNetwork                      href='"+i+"' />                   <FenceMode>bridged</FenceMode>                </Configuration>             </NetworkConfig>          </NetworkConfigSection>":"")+"</InstantiationParams>       <Source          href='"+j+"' />    </InstantiateVAppTemplateParams>"};function Metadata(a){var f=0,g={},i={register:function(e,d){g[e]=d}},j=function(e,d,a){vmware.rest.get(e).done(function(e){e=a($.parseXML(e.xml?e.xml:(new XMLSerializer).serializeToString(e)));if(g[d])g[d](e);delete g[d]})},h=function(e){for(var d={},e=e.getElementsByTagName("MetadataEntry"),a=0;a<e.length;a++)d[e[a].getElementsByTagName("Key")[0].childNodes[0].nodeValue]=e[a].getElementsByTagName("Value")[0].childNodes[0].nodeValue;return d},n=function(e){for(var d={},e=0!=e.getElementsByTagName("VAppRecord").length?
e.getElementsByTagName("VAppRecord"):e.getElementsByTagName("VAppTemplateRecord"),a=0;a<e.length;a++)d[e[a].getAttribute("href")]=e[a].getElementsByTagName("Value")[0].childNodes[0].nodeValue;return d};i.get=function(e){var d=f++;j(e.getHref()+"/metadata",d,h);return d};i.filterTemplates=function(e){var d=f++;j(a.concat("query?type=vAppTemplate&fields=metadata:"+e+"&filter=metadata:"+e+"=ge=NUMBER:0"),d,n);return d};i.filterVApps=function(e){var d=f++;j(a.concat("query?type=vApp&fields=metadata:"+
e+"&filter=metadata:"+e+"=ge=NUMBER:0"),d,n);return d};i.set=function(e,d,a){var h=f++,e=e.getHref()+"/metadata",d='<Metadata            xmlns="http://www.vmware.com/vcloud/v1.5"            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"            type="application/vnd.vmware.vcloud.metadata+xml">                <MetadataEntry                    type="application/vnd.vmware.vcloud.metadata.value+xml">                        <Key>'+d+'</Key>                        <TypedValue                            xsi:type="Metadata'+
(typeof a).substring(0,1).toUpperCase()+(typeof a).substr(1)+'Value">                                <Value>'+a+"</Value>                        </TypedValue>                </MetadataEntry>        </Metadata>";vmware.rest.addHeader("Content-Type","application/vnd.vmware.vcloud.metadata+xml");vmware.rest.post(e,d).done(function(){if(g[h])g[h](void 0);delete g[h]});return h};return i};function vObj(){this.cloud=null;this.zfavorite=!1;this.STATUS_ON=0;this.STATUS_OFF=1;this.STATUS_WORKING=2;this.STATUS_SUSPENDED=3;this.STATUS_ERROR=4;this.STATUS_PARTIAL=5;this.addChild=function(a){this.children.push(a)};this.setAttr=function(a,f){this.attr[a]=f};this.getAttr=function(a){return this.attr[a]};this.addLink=function(a,f){this.links[a]=f};this.getID=function(){return this.attr.id};this.getName=function(){return this.attr.name};this.getHref=function(){return this.attr.href};this.save=
function(){return{attr:this.attr,links:this.links,children:this.children,favorite:this.zfavorite}};this.load=function(a){this.attr=a.attr||this.attr;this.links=a.links||this.links;this.children=a.children||this.children;this.zfavorite=a.favorite||this.zfavorite};this.favorite=function(a){null!=a&&(this.zfavorite=a);return this.zfavorite};this.getDescription=function(){return this.attr.description};this.getStatusMessage=function(){switch(this.getStatus()){case this.STATUS_ON:return localizer.get("STATUS_ON");
case this.STATUS_OFF:return localizer.get("STATUS_OFF");case this.STATUS_ERROR:return localizer.get("STATUS_ERROR");case this.STATUS_WORKING:return localizer.get("STATUS_WORKING");case this.STATUS_PARTIAL:return localizer.get("STATUS_PARTIAL");case this.STATUS_SUSPENDED:return localizer.get("STATUS_SUSPENDED")}};this.isVM=function(){return null!=this.attr.guestOS};this.canPowerOn=function(){return-1!=[this.STATUS_OFF,this.STATUS_PARTIAL,this.STATUS_SUSPENDED].indexOf(this.getStatus())&&null!=this.links["power:powerOn"]};
this.canPowerOff=function(){return-1!=[this.STATUS_ON,this.STATUS_PARTIAL,this.STATUS_SUSPENDED].indexOf(this.getStatus())&&null!=this.links["power:powerOff"]};this.canSuspend=function(){return this.getStatus()==this.STATUS_ON&&null!=this.links["power:suspend"]};this.powerOn=function(){return this.cloud.powerOn(this.getID())};this.powerOff=function(){return this.cloud.powerOff(this.getID())};this.suspend=function(){return this.cloud.suspend(this.getID())}}vApp.prototype=new vObj;
vApp.prototype.constructor=vApp;
function vApp(a){this.cloud=a;this.children=[];this.attr={};this.links={};this.searchTerm=function(){return this.attr.searchTerm};this.getNumberOfVMs=function(){return this.children.length};this.getOwnerName=function(){return this.attr.ownerName};this.getCreationDate=function(){return this.attr.creationDate};this.getChildren=function(){return this.children.map(a.getVM)};this.canDelete=function(){return null!=this.links.remove};this.getVDCName=function(){return this.attr.vdcName};this.edit=function(f,
g){return a.editVApp(this.getID(),f,g)};this.getStatus=function(){for(var a=this.cloud.taskManager.inProgress(),g=0;g<a.length;g++)if(-1!=this.getID().indexOf(a[g]))return this.STATUS_WORKING;for(var a=0,i=this.children.length,j=this.getChildren(),g=0;g<j.length;g++)switch(stat=j[g].getStatus(),stat){case this.STATUS_ON:a++;break;case this.STATUS_SUSPENDED:a+=3.1415;break;case this.STATUS_ERROR:return this.STATUS_ERROR}g=3.1415*i;switch(a){case 0:return this.STATUS_OFF;case i:return this.STATUS_ON;
case g:return this.STATUS_SUSPENDED;default:return this.STATUS_PARTIAL}}}vM.prototype=new vObj;vM.prototype.constructor=vM;
function vM(a){this.cloud=a;this.children=[];this.attr={};this.links={};this.consoleThumbnail="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAwCAIAAAAuKetIAAAAH0lEQVRoge3BAQEAAACCIP+vbkhAAQAAAAAAAAAALwYkMAABjuvAZwAAAABJRU5ErkJggg==";this.getStatus=function(){return 4==this.attr.status?this.STATUS_ON:8==this.attr.status?this.STATUS_OFF:3==this.attr.status?this.STATUS_SUSPENDED:this.STATUS_ERROR};this.getGuestOS=function(){return this.attr.guestOS};this.getNetwork=function(){return this.attr.network};
this.getIP=function(){return this.attr.ip};this.updateConsoleThumbnail=function(){var a=this,g=this.links["screen:thumbnail"];"undefined"!=g&&(vmware.rest.removeAllHeaders(),vmware.rest.addHeader("Accept","application/*+xml;version=5.1"),vmware.rest.get(g).fail(function(g){4==g.readyState&&200==g.status&&(g=g.responseText,0!=g&&(a.thumbnail=g))}))};this.getConsoleTicket=function(){var a=this.links["screen:acquireTicket"];if(void 0==a)return console.log("Unable to open console. The VM should be powered-on."),
!1;this.cloud.fetchURL(a,"POST","",function(a){var a=a.getElementsByTagName("ScreenTicket")[0].childNodes[0].nodeValue,f;f=(f=/mks:\/\/([^\/]*)\/([^\?]*)\?ticket=(.*)/.exec(a))?{host:f[1],moid:f[2],ticket:unescape(f[3])}:!1;console.log("vCD ScreenTicket: "+a);this.cloud.fetchURL("https://"+f.host+":9443/sdk","SOAP","*/*",function(){console.log("Host ticket fetched")},'<CloneSession xmlns="urn:vim25"><_this type="SessionManager">SessionManager</_this><cloneTicket xsi:type="xsd:string">'+f.ticket+"</cloneTicket></CloneSession>")})}}
function Template(){this.attr={searchTerm:""};this.xml="";this.setAttr=function(a,f){this.attr[a]=f};this.getAttr=function(a){return this.attr[a]};this.save=function(){return{attr:this.attr}};this.load=function(a){this.attr=a.attr||this.attr};this.getHref=function(){return this.getAttr("href")};this.getName=function(){return this.getAttr("name")};this.getDescription=function(){return this.getAttr("description")};this.getDownloads=function(){return this.getAttr("downloads")};this.getNetwork=function(){return this.getAttr("network")};
this.getChildren=function(){return this.getAttr("childNames")};this.getOwnerName=function(){return this.getAttr("owner")};this.getCatalogName=function(){return this.getAttr("catalog")};this.getCPUMhz=function(){return this.getAttr("cpu")};this.getMemoryMB=function(){return this.getAttr("memory")};this.getStorageKB=function(){return this.getAttr("storage")}};vmware="undefined"==typeof vmware||!vmware?{}:vmware;
vmware.rest=function(){var a={},f={},g=function(g,f,i){return $.ajax(f,{type:g,headers:a,dataType:i||"xml"})},i=function(g,f,i,e){return $.ajax(f,{type:g,data:i,headers:a,dataType:e||"xml"})};f.dataType="xml";f.addHeader=function(g,f){a[g]=f};f.hasHeader=function(g){return null!=a[g]};f.removeHeader=function(g){delete a[g]};f.removeAllHeaders=function(){a={}};f.get=function(a){return g("GET",a)};f.postGetJSON=function(a,f){return f?i("POST",a,f,"json"):g("POST",a,"json")};f.post=function(a,f){return f?
i("POST",a,f):g("POST",a)};f.put=function(a,f){return f?i("PUT",a,f):g("PUT",a)};f.del=function(a){return g("DELETE",a)};return f}();vmware="undefined"==typeof vmware||!vmware?{}:vmware;
vmware.soap=function(){var a={};return{dataType:"xml",addHeader:function(f,g){a[f]=g},hasHeader:function(f){return null!=a[f]},removeHeader:function(f){delete a[f]},removeAllHeaders:function(){a={}},post:function(f,g){return $.ajax(f,{type:"POST",data:'<?xml version="1.0" encoding="UTF-8"?><soapenv:Envelope xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsd="http:/www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><soapenv:Body>'+g+
"</soapenv:Body></soapenv:Envelope>",headers:a,dataType:"xml",cache:!1})}}}();function TaskManager(a){var f,g={},i={},j=function(){this.attr={}};j.prototype.addAttr=function(a,d){this.attr[a]=d};var h={autoRefresh:null,update:function(){clearTimeout(f);var e=!1;for(key in g)a.fetchURL(g[key].attr.href,"GET",null,h.refreshTask),e=!0;h.autoRefresh&&h.autoRefresh(h.loadTasks);f=e?setTimeout("cloud.taskManager.update();",5E3):setTimeout("cloud.taskManager.update();",1E4)},loadTasks:function(a){h.loadTasksTo(g)(a)},loadTasksLog:function(a){h.loadTasksTo(i)(a)},loadTasksTo:function(a){return function(d){var g,
f;for(f=0;f<d.getElementsByTagName("TaskRecord").length;f++){g=new j;for(var h=d.getElementsByTagName("TaskRecord")[f],i=0;i<h.attributes.length;i++)g.addAttr(h.attributes[i].name,h.attributes[i].value);a[g.attr.href]=g}}},newTask:function(e){h.refreshTask(e);a.trigger(vmware.events.cloud.TASK_START)},refreshTask:function(e){for(var d=new j,f=e.getElementsByTagName("Task")[0],p=0;p<f.attributes.length;p++)d.addAttr(f.attributes[p].name,f.attributes[p].value);0!=e.getElementsByTagName("Link").length&&
d.addAttr("cancel",e.getElementsByTagName("Link")[0].getAttribute("href"));d.addAttr("ownerHref",e.getElementsByTagName("Owner")[0].getAttribute("href"));d.addAttr("user",e.getElementsByTagName("User")[0].getAttribute("name"));0!=e.getElementsByTagName("Progress").length&&d.addAttr("progress",e.getElementsByTagName("Progress")[0].childNodes[0].data);null==i[d.attr.href]&&("success"==d.attr.status?(f={success:!0,data:d},i[d.attr.href]=d,-1!=d.attr.ownerHref.match("vapp")&&h.addFakeTask(d.attr.ownerHref),
delete g[d.attr.href],null==d.attr.progress&&null==d.attr.name.match("elete")&&null==d.attr.operationName.match("elete")?a.trigger(vmware.events.cloud.TASK_COMPLETE,f):a.updateModels()):"error"==d.attr.status?(f={success:!1,data:d},message=e.getElementsByTagName("Error")[0].getAttribute("message")||(e.getElementsByTagName("Details")[0].childNodes[0]?e.getElementsByTagName("Details")[0].childNodes[0].data:null),d.addAttr("error",message),i[d.attr.href]=d,delete g[d.attr.href],a.trigger(vmware.events.cloud.TASK_COMPLETE,
f)):g[d.attr.href]=d)},numberOfTasks:function(){return h.inProgress().length},saveLog:function(){return i},loadLog:function(a){i=a},details:function(a){return task=null==g[a]?i[a]:g[a]},taskLog:function(){for(var a=[],d=[i,g],f={},h=0;h<d.length;h++)for(key in d[h])f[key]=d[h][key];for(key in f)a.push([null!=f[key].attr.ownerName?f[key].attr.ownerName:f[key].attr.user,n("task"!=f[key].attr.name?f[key].attr.name:f[key].attr.operationName),null!=f[key].attr.startDate?f[key].attr.startDate:f[key].attr.startTime,
f[key].attr.status,key]);return a.sort(function(a,d){return a[2]>d[2]?-1:a[2]<d[2]?1:0})}},n=function(a){var d={poweron:localizer.get("TASK_POWERING_ON"),poweroff:localizer.get("TASK_POWERING_OFF"),acquirescreen:localizer.get("TASK_CONSOLE"),suspend:localizer.get("TASK_SUSPEND"),instantiate:localizer.get("TASK_CREATE_VAPP"),"delete":localizer.get("TASK_DELETE"),jobundeploy:localizer.get("TASK_UNDEPLOY_VAPP"),jobdeploy:localizer.get("TASK_DEPLOY_VAPP"),vappundeploy:localizer.get("TASK_UNDEPLOY_VAPP"),
vappdeploy:localizer.get("TASK_DEPLOY_VAPP"),update:localizer.get("TASK_EDIT_VAPP"),uploadovf:localizer.get("TASK_UPLOAD_OVF")},f;for(f in d)if(null!=a.toLowerCase().match(f))return d[f];return a};h.tasksPerHour=function(){hours=[];count=0;tl=h.taskLog();for(var a=0;a<tl.length;a++)newdate=new Date(tl[a][2]),(0==hours.length||36E5<hours[hours.length-1]-newdate)&&hours.push(newdate);return tl.length/hours.length};h.tasks=function(){return g};h.fakeTasks={};h.addFakeTask=function(e){h.fakeTasks[e]=
1;a.trigger(vmware.events.cloud.REFRESH_SINGLE,{vapp:a.getVAppFromHref(e),dontdeleteplease:1})};h.inProgress=function(){var a=[];for(key in g)g[key].attr.ownerHref&&a.push(g[key].attr.ownerHref.split("/")[g[key].attr.ownerHref.split("/").length-1].split("-").slice(1).join("-"));for(key in h.fakeTasks)a.push(key.split("/")[key.split("/").length-1].split("-").slice(1).join("-"));return a};h.update();a.register(vmware.events.cloud.REFRESH_COMPLETE,function(){h.fakeTasks={}});a.register(vmware.events.cloud.REFRESH_SINGLE,
function(e){null==e.eventData.dontdeleteplease&&(h.fakeTasks={},e.eventData.dontdeleteplease=1,a.trigger(vmware.events.cloud.REFRESH_SINGLE,e.eventData))});return h};localizer={lang:0,languages:{EN:0},setlang:function(a){lang=a;this[lang]||(this[lang]={});return this},add:function(a,f){this[lang][a]=f;return this},get:function(a){return this[lang]?this[lang][a]:a}};
localizer.setlang(localizer.languages.EN).add("SYSTEM_NOT_SUPPORTED","You are attempting to connect to a system no longer supported.").add("LOST_CONNECTIVITY","You seem to have lost connectivity - your changes will not be saved until connectivity is reestablished.").add("STATUS_ON","Powered On").add("STATUS_OFF","Powered Off").add("STATUS_ERROR","Error!").add("STATUS_WORKING","Working...").add("STATUS_PARTIAL","Partially On").add("STATUS_SUSPENDED","Suspended").add("TASK_POWERING_ON","Powering On").add("TASK_POWERING_OFF",
"Powering Off").add("TASK_CONSOLE","Connecting To Console").add("TASK_SUSPEND","Suspending").add("TASK_CREATE_VAPP","Creating vApp").add("TASK_DELETE","Deleting").add("TASK_UNDEPLOY_VM","Undeploying VM").add("TASK_DEPLOY_VM","Deploying VM").add("TASK_UNDEPLOY_VAPP","Undeploying vApp").add("TASK_DEPLOY_VAPP","Deploying vApp").add("TASK_EDIT_VAPP","Editing vApp").add("TASK_UPLOAD_OVF","Uploading OVF");
