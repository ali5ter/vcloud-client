/*
 VMware Cloud Director JavaScript SDK Library

 Copyright (c) 2012 VMware, Inc. All rights reserved.

*/
var vmware="undefined"==typeof vmware||!vmware?{}:vmware;vmware.events="undefined"==typeof vmware.events||!vmware.events?{}:vmware.events;var global,global2,imageData;vmware.cloudVersion={V1_0:"1.0",V1_5:"1.5",V5_1:"5.1"};var connectivity=1;
vmware.events.cloud={INITIALIZATION_COMPLETE:"event.cloud.initialization.complete",LOGIN:"event.cloud.login",TASK_START:"event.cloud.task.start.",TASK_COMPLETE:"event.cloud.task.complete.",REFRESH_COMPLETE:"event.cloud.refresh.complete",REFRESH_SINGLE:"event.cloud.refresh.single",TEMPLATE_REFRESH:"event.cloud.template.refresh",SEARCH_COMPLETE:"event.cloud.search.complete",PROGRESS_UPDATE:"event.cloud.progress.update",NEW_TICKET:"event.cloud.ticket.new",ERROR:"event.cloud.error",TEMPLATE_FILLED:"event.cloud.template.filled."};
vmware.cloud=function(b,f){var g="";vmware.rest.get(b.concat("versions")).done(function(d){$(d).find("VersionInfo").each(function(){$(this).find("Version").text()==f&&(g=$(this).find("LoginUrl").text(),a.trigger(vmware.events.cloud.INITIALIZATION_COMPLETE))});""==g&&a.trigger(vmware.events.cloud.ERROR,localizer.get("SYSTEM_NOT_SUPPORTED"))}).error(function(){a.trigger(vmware.events.cloud.ERROR,localizer.get("SYSTEM_NOT_SUPPORTED"))});var i={vapps:{},vms:{}},j={vapps:{},vms:{}},h=[],n={},e={},a=vmware.eventManager({});
a.base=b;a.login=function(d,l,k){$.base64.encode(d+"@"+k+":"+l);vmware.rest.addHeader("Authorization","Basic "+$.base64.encode(d+"@"+k+":"+l));vmware.rest.addHeader("Accept","application/*+xml;version=5.1");vmware.rest.post(g).done(function(d){var d={success:!0,data:$.parseXML(d.xml?d.xml:(new XMLSerializer).serializeToString(d))},l=d.data.childNodes[0].getAttribute("user"),k=d.data.childNodes[0].getAttribute("org"),e=$(d.data).find('Link[href*="/api/admin"]').attr("href"),b=$(d.data).find('Link[name="'+
k+'"]').attr("href");a.user=new z(l,k,b,e);a.begin();a.trigger(vmware.events.cloud.LOGIN,d)}).fail(function(d){a.trigger(vmware.events.cloud.LOGIN,{success:!1,data:d.statusText})})};a.confirmLoggedIn=function(){vmware.rest.addHeader("Accept","application/*+xml;version=5.1");vmware.rest.get(b.concat("session")).done(function(d){var d={success:!0,confirm:!0,data:$.parseXML(d.xml?d.xml:(new XMLSerializer).serializeToString(d))},l=d.data.childNodes[0].getAttribute("user"),k=d.data.childNodes[0].getAttribute("org"),
e=$(d.data).find('Link[href*="/api/admin"]').attr("href"),b=$(d.data).find('Link[name="'+k+'"]').attr("href");a.user=new z(l,k,b,e);a.begin();a.trigger(vmware.events.cloud.LOGIN,d)}).fail(function(d){a.trigger(vmware.events.cloud.LOGIN,{success:!1,confirm:!0,data:d.statusText})})};a.fetchURL=function(d,l,k,e,b){var g=function(a){null!=e&&e($.parseXML(a.xml?a.xml:(new XMLSerializer).serializeToString(a)))};vmware.rest.removeAllHeaders();k?vmware.rest.addHeader("Accept",k):vmware.rest.addHeader("Accept",
"application/*+xml;version=5.1");"GET"==l||null==l?vmware.rest.get(d).done(function(a){connectivity=1;g(a)}).fail(function(d){connectivity&&(console.warn("Fetch error: "+d.statusText),connectivity=0,a.trigger(vmware.events.cloud.ERROR,localizer.get("LOST_CONNECTIVITY")))}):"POST"==l?vmware.rest.post(d).done(function(a){g(a)}).fail(function(a){console.warn("Post error: "+a.statusText)}):"DELETE"==l?vmware.rest.del(d).done(function(a){g(a)}).fail(function(a){console.warn("Delete error: "+a.statusText)}):
"SOAP"==l&&(vmware.soap.addHeader("Content-Type","text/xml; charset=utf-8"),vmware.soap.addHeader("SOAPAction","urn:vim25/4.1"),vmware.soap.post(d,b).done(function(a){g(a)}).fail(function(a,d){console.warn("SOAP error: "+d)}))};var o=function(d){if(!1==p.comissioning)if(setTimeout(function(){p.comissioning=!1},3E4),p.comissioning=!0,d=d.getElementsByTagName("VAppRecord"),0!=d.length){j.vapps={};j.vms={};for(var l,k=0;k<d.length;k++)if("VAppRecord"==d[k].nodeName){l=new vApp(a);for(var e=0;e<d[k].attributes.length;e++)l.setAttr(d[k].attributes[e].name,
d[k].attributes[e].value);a.fetchURL(d[k].getAttribute("href"),null,null,A(l))}}else a.trigger(vmware.events.cloud.REFRESH_COMPLETE,!1),p.comissioning=!1},p=this,r=this.comissioning=!1,s=0,q=0,B=function(d){0!=q&&(a.trigger(vmware.events.cloud.PROGRESS_UPDATE,a.percentageDoneUpdate()),s++,s==q&&(q=s=0,!1==r&&(i=j),j={vapps:[],vms:[]},p.comissioning=!1,!0==r?a.trigger(vmware.events.cloud.REFRESH_SINGLE,{vapp:d}):a.trigger(vmware.events.cloud.REFRESH_COMPLETE,!0),r=!1))},F=function(d){q=0;for(var d=
d.getElementsByTagName("VMRecord"),l=0;l<d.length;l++)"UNRESOLVED"!=d[l].getAttribute("status")&&"false"==d[l].getAttribute("isVAppTemplate")&&q++;a.fetchURL(b.concat("query?type=vApp&format=records&pageSize=1024"),"GET",null,o)},A=function(d){return function(l){var k=namespacex="";null!=l.childNodes[0].getAttribute("xmlns:vcloud")&&(k="vcloud",namespacex=k+":");k=""==k?function(a){return l.getElementsByTagName(a)}:function(a){return l.getElementsByTagNameNS(l.childNodes[0].getAttribute("xmlns:vcloud"),
a)};if(l.childNodes[0].nodeName==namespacex+"VApp"){var e=k("Description")[0].childNodes;e&&e.length&&d.setAttr("description",e[0].nodeValue);for(e=0;e<l.childNodes[0].attributes.length;e++)d.setAttr(l.childNodes[0].attributes[e].name,l.childNodes[0].attributes[e].value);(e=k("DateCreated")[0].childNodes)&&e.length&&d.setAttr("creationDate",e[0].nodeValue);(e=k("Owner")[0].childNodes)&&e.length&&d.setAttr("ownerName",e[1].getAttribute("name"));r?i.vapps[d.getID()]=d:j.vapps[d.getID()]=d;for(var e=
k("Link"),b=0;b<e.length;b++)l.childNodes[0].nodeName==e[b].parentNode.nodeName&&d.addLink(e[b].getAttribute("rel"),e[b].getAttribute("href"));d.setAttr("searchTerm","name:"+d.getName()+"owner:"+d.getOwnerName()+"status:"+d.getStatusMessage()+"description:"+d.getDescription());d.setAttr("searchTerm",d.getAttr("searchTerm").toLowerCase());d.children=[];var g=k("Vm");r&&(q=g.length);for(b=0;b<g.length;b++){getTag=function(a){return g[b].getElementsByTagName(a)};for(var h=new vM(a),e=0;e<g[b].attributes.length;e++)h.setAttr(g[b].attributes[e].name,
g[b].attributes[e].value);null!=getTag("IpAddress")[0]&&h.setAttr("ip",getTag("IpAddress")[0].childNodes[0].nodeValue);null!=l.getElementsByTagNameNS("http://schemas.dmtf.org/ovf/envelope/1","Description")[0]&&h.setAttr("guestOS",g[b].getElementsByTagNameNS("http://schemas.dmtf.org/ovf/envelope/1","Description")[0].childNodes[0].nodeValue);null!=k("NetworkConnection")[0]&&h.setAttr("network",getTag("NetworkConnection")[0].getAttribute("network"));(e=getTag("Description")[0].childNodes)&&e.length&&
h.setAttr("description",e[0].nodeValue);for(var e=k("Link"),f=0;f<e.length;f++)g[b].nodeName==e[f].parentNode.nodeName&&h.addLink(e[f].getAttribute("rel"),e[f].getAttribute("href"));h.updateConsoleThumbnail();d.children.push(h.getID());r?(i.vms[h.getID()]=h,B(d)):(j.vms[h.getID()]=h,B())}}}},u=function(d,e){if(null!=a.getVM(d))a.fetchURL(a.getVM(d).links[e],"POST",null,a.taskManager.newTask);else if(null!=a.getVApp(d)){a.taskManager.addFakeTask(a.getVApp(d).getHref());if("power:powerOff"==e)return vmware.rest.addHeader("Content-Type",
"application/vnd.vmware.vcloud.undeployVAppParams+xml"),xml='<?xml version="1.0" encoding="UTF-8"?>                    <UndeployVAppParams                       xmlns="http://www.vmware.com/vcloud/v1.5">                       <UndeployPowerAction>powerOff</UndeployPowerAction>                    </UndeployVAppParams>',vmware.rest.post(a.getVApp(d).links.undeploy,xml).done(function(d){a.taskManager.newTask($.parseXML(d.xml?d.xml:(new XMLSerializer).serializeToString(d)))}),!0;"remove"==e?a.fetchURL(a.getVApp(d).links[e],
"DELETE",null,a.taskManager.newTask):a.fetchURL(a.getVApp(d).links[e],"POST",null,a.taskManager.newTask)}else{var k;k=b.concat("vApp/"+d.split(":")[d.split(":").length-2]+"-"+d.split(":")[d.split(":").length-1]);k="power"==e.split(":")[0]?k+"/power/action/"+e.split(":")[1]:k+"/action/"+e;a.fetchURL(k,"POST",null,a.taskManager.newTask)}},w={ownerName:"owner",memoryAllocationMB:"memory",catalogName:"catalog",storageKB:"storage",cpuAllocationMhz:"cpu"},x=function(d,e,b){return function(g){var f=g.getElementsByTagName("VAppTemplateRecord");
if(0!=f.length)for(var i,j=0;j<f.length;j++){i=new Template;for(var o=0;o<f[j].attributes.length;o++)i.setAttr(w[f[j].attributes[o].name]?w[f[j].attributes[o].name]:f[j].attributes[o].name,f[j].attributes[o].value),i.setAttr("searchTerm",i.getAttr("searchTerm")+(w[f[j].attributes[o].name]?w[f[j].attributes[o].name]:f[j].attributes[o].name)+":"+f[j].attributes[o].value);h[(d-1)*e+j]=i}if(b){g=g.getElementsByTagName("Link");for(j=0;j<g.length;j++)if("nextPage"==g[j].getAttribute("rel")){a.fetchURL(g[j].getAttribute("href"),
"GET",null,x(d+1,128,!0));return}y=!0}a.trigger(vmware.events.cloud.TEMPLATE_REFRESH,h)}};a.user=null;var z=function(a,e,b,g){return{getName:function(){return a},getOrg:function(){return e},getAdminUrl:function(){return g},getOrgUrl:function(){return b}}};a.getUserName=function(){return this.user.getName()};a.getUserOrg=function(){return this.user.getOrg()};a.getAdminUrl=function(){return this.user.getAdminUrl()};a.getUserOrgUrl=function(){return this.user.getOrgUrl()};a.fleshOutTemplate=function(d){null==
d.getAttr("childNames")?a.fetchURL(d.getHref(),"GET",null,C(d)):a.trigger(vmware.events.cloud.TEMPLATE_FILLED+d.getHref(),d)};a.fleshOutMultiple=function(d){for(var e=d.length,b=0,g=0;g<e;g++)templ=d[g],a.once(vmware.events.cloud.TEMPLATE_FILLED+templ.getHref(),function(){b++;b==e&&a.trigger(vmware.events.cloud.TEMPLATE_FILLED)}),a.fetchURL(templ.getHref(),"GET",null,C(templ))};var C=function(d){return function(e){null!=e.getElementsByTagName("Description")[0].childNodes[0]&&d.setAttr("description",
e.getElementsByTagName("Description")[0].childNodes[0].nodeValue);null!=e.getElementsByTagName("NetworkConfig")[0]&&d.setAttr("network",e.getElementsByTagName("NetworkConfig")[0].getAttribute("networkName"));d.setAttr("childNames",[]);for(var b=0;b<e.getElementsByTagName("Vm").length;b++)d.setAttr("childNames",d.getAttr("childNames").concat(e.getElementsByTagName("Vm")[b].getAttribute("name")));a.trigger(vmware.events.cloud.TEMPLATE_FILLED+d.getHref(),d)}};a.getAllTemplates=function(){a.fetchURL(b.concat("query?type=vAppTemplate&format=records&page=1&pageSize=128"),
"GET",null,x(1,128,!0))};var D=function(d,e,g){a.fetchURL(b.concat("query?type="+d+"&format=records"),"GET",null,G(e,g))},G=function(a,e){return function(b){for(var b=b.getElementsByTagName(a),g=0;g<b.length;g++)-1!=b[g].getAttribute("linkType")&&(e[b[g].getAttribute("name")]=b[g].getAttribute("href"))}};a.metrics=function(){m={totalStorage:0,totalMemory:0,totalRunning:0,totalStopped:0,totalSuspended:0,totalError:0,tasksPerHour:0};temp=a.getVApps(a.SORTBY.DATE);for(var d=0;d<temp.length;d++){switch(temp[d].getStatus()){case temp[d].STATUS_OFF:m.totalStopped++;
break;case temp[d].STATUS_SUSPENDED:m.totalSuspended++;break;case temp[d].STATUS_ERROR:m.totalError++;break;default:m.totalRunning++}m.totalStorage+=parseInt(temp[d].getAttr("storageKB"))/1E3;m.totalMemory+=parseInt(temp[d].getAttr("memoryAllocationMB"))}m.tasksPerHour=Math.ceil(a.taskManager.tasksPerHour());return m};var y=!1,E=function(d){return function(){global=d;y=!0;for(var e=[],b,g=0;g<h.length;g++)if(b=!0,h[g]){for(var f in d)if(d[f].match("-")){if(terms=d[f].split("-"),!(""==terms[0].replace(" ",
"").replace(",","")||parseInt(terms[0].replace(" ","").replace(",",""))<=parseInt(h[g].getAttr(f)))||!(""==terms[1].replace(" ","").replace(",","")||parseInt(terms[1].replace(" ","").replace(",",""))>=parseInt(h[g].getAttr(f)))){b=!1;break}}else for(var j=0;j<d[f].split(" ").length;j++)if(""!=d[f].split(" ")[j]&&(null==h[g].getAttr(f)||null==h[g].getAttr(f).toLowerCase().match(d[f].split(" ")[j].toLowerCase()))){b=!1;break}b&&e.push(h[g])}a.trigger(vmware.events.cloud.SEARCH_COMPLETE,e)}};a.getNetworks=
function(){names=[];for(var a in n)names.push(a);return names};a.getVdcList=function(){names=[];for(var a in e)names.push(a);return names};a.editVApp=function(d,e,b){e='<?xml version="1.0" encoding="UTF-8" standalone="no"?>                        <vcloud:VApp                            xmlns:vcloud="http://www.vmware.com/vcloud/v1.5"                            name="'+(e||a.getVApp(d).getName())+'">                            <vcloud:Description>'+(b||a.getVApp(d).getDescription())+"</vcloud:Description>                    </vcloud:VApp>";
vmware.rest.addHeader("Content-Type","application/vnd.vmware.vcloud.vApp+xml");vmware.rest.put(a.getVApp(d).getHref(),e).done(function(d){a.taskManager.newTask($.parseXML(d.xml?d.xml:(new XMLSerializer).serializeToString(d)))})};a.instantiateVApp=function(d,b,g,f,h,j){templateObj=a.getTemplateFromHref(h);if(!e[g]||!templateObj)return!1;a.once(vmware.events.cloud.TEMPLATE_FILLED+h,function(i){networkName=i.eventData.getNetwork();f=n[f]?f:n[0];i=instantTempParams(d,b,networkName,n[f],h,j);vmware.rest.addHeader("Content-Type",
"application/vnd.vmware.vcloud.instantiateVAppTemplateParams+xml");vmware.rest.post(e[g]+"/action/instantiateVAppTemplate",i).done(function(d){a.once(vmware.events.cloud.TASK_START,a.updateModels);a.taskManager.newTask($.parseXML(d.xml?d.xml:(new XMLSerializer).serializeToString(d)))}).fail(function(d){a.trigger(vmware.events.cloud.ERROR,$(d.responseXML).find("Error").attr("message"))})});a.fleshOutTemplate(templateObj);return!0};a.searchCatalogFaceted=function(d){y?E(d)():(a.once(vmware.events.cloud.TEMPLATE_REFRESH,
E(d)),a.getAllTemplates())};a.searchCatalog=function(d){a.searchCatalogFaceted({searchTerm:d})};a.taskHistory=function(){return a.taskManager.taskLog()};a.updateModels=function(){a.fetchURL(b.concat("query?type=vm&format=records&pageSize=1024"),"GET",null,F)};a.begin=function(){a.metadata=new Metadata(b);a.taskManager=new TaskManager(a);a.register(vmware.events.cloud.TASK_COMPLETE,a.updateSingle);D("orgVdcNetwork","OrgVdcNetworkRecord",n);D("orgVdc","OrgVdcRecord",e);a.taskManager.autoRefresh=function(d){a.fetchURL(b.concat("query?type=task&filter=(status==running)"),
"GET",null,d)};a.fetchURL(b.concat("query?type=task&pageSize=15&sortDesc=startDate"),"GET",null,a.taskManager.loadTasksLog);a.updateModels();a.getAllTemplates();a.once(vmware.events.cloud.TEMPLATE_REFRESH,function(){a.metadata.register(a.metadata.filterTemplates("downloads"),function(d){for(t in d)a.getTemplateFromHref(t).setAttr("downloads",d[t])})})};a.updateSingle=function(d){d=d.eventData.data;r=!0;a.fetchURL(d.attr.ownerHref,"GET",null,A(a.getVAppFromHref(d.attr.ownerHref)||new vApp(a),!0))};
a.updateCatalog=function(d,e){for(var g=(d-1)*e;g<d*e;g++)if(null==h[g])return a.fetchURL(b.concat("query?type=vAppTemplate&format=records&page="+d+"&pageSize="+e),"GET",null,x(d,e,!1));a.trigger(vmware.events.cloud.TEMPLATE_REFRESH,h)};a.getCatalog=function(){return h};a.getVMStatus=function(d){for(var e=a.taskManager.inProgress(),b=0;b<e.length;b++)if(null!=d.getID().match(e[b]))return d.STATUS_WORKING;return d.getStatus()};a.percentageDoneUpdate=function(){return 0!=q?100*s/q:0};a.getVApps=function(d){list=
[];for(var e in i.vapps)list.push(i.vapps[e]);if(null!=d){switch(d){case a.SORTBY.NAME:sorter=function(a,d){return a.getName()>d.getName()};break;case a.SORTBY.DATE:sorter=function(a,d){return a.getCreationDate()>d.getCreationDate()}}return list.sort(sorter)}return list};a.SORTBY={NAME:0,DATE:1};a.getVMs=function(){list=[];for(var a in i.vms)list.push(i.vms[a]);return list};a.getVM=function(a){return i.vms[a]};a.getVApp=function(a){return i.vapps[a]};a.getVObject=function(d){return a.getVApp(d)||
a.getVM(d)};a.getVAppFromHref=function(a){for(var e in i.vapps)if(i.vapps[e].getAttr("href")==a)return i.vapps[e]};a.getTemplateFromHref=function(a){for(var e in h)if(h[e].getAttr("href")==a)return h[e]};a.powerOff=function(a){u(a,"power:powerOff")};a.powerOn=function(a){u(a,"power:powerOn")};a.suspend=function(a){u(a,"power:suspend")};a.deleteVApp=function(a){u(a,"remove")};a.displayConsole=function(d,e){a.once(vmware.events.cloud.NEW_TICKET,function(){});e.getConsoleTicket()};a.saveCache=function(){for(var d=
{vapps:[]},e=a.getVApps(),b=0;b<e.length;b++)d.vapps.push(e[b].save());d.vms=[];e=a.getVMs();for(b=0;b<e.length;b++)d.vms.push(e[b].save());d.catalog=[];e=a.getCatalog();for(b=0;b<e.length;b++)d.catalog.push(e[b].save());d.tasks=a.taskManager.saveLog();return JSON.stringify(d)};a.loadCache=function(d){d=JSON.parse(d);i={vapps:{},vms:{}};h=[];for(var e,b=0;b<d.vapps.length;b++)e=new vApp(a),e.load(d.vapps[b]),i.vapps[e.getID()]=e;for(b=0;b<d.vms.length;b++)e=new vM(a),e.load(d.vms[b]),i.vms[e.getID()]=
e;for(b=0;b<d.catalog.length;b++)e=new Template,e.load(d.catalog[b]),h.push(e);a.taskManager.loadLog(d.tasks);a.trigger(vmware.events.cloud.REFRESH_COMPLETE)};return a};vmware="undefined"==typeof vmware||!vmware?{}:vmware;vmware.events.log=[];
vmware.eventManager=function(b){var f={};b.register=function(b,i,j){vmware.events.log.push("Registering "+String(i).split(" ")[1]+" with "+b);i={method:i,handlerData:j};f.hasOwnProperty(b)?f[b].push(i):f[b]=[i]};b.unregister=function(b,i){vmware.events.log.push("Unregistering "+String(i).split(" ")[1]+" with "+b);for(var j=f[b].length-1;0<=j;j--)f[b][j].method===i&&f[b].splice(j,1)};b.trigger=function(b,i){if(f.hasOwnProperty(b)){var j=f[b];vmware.events.log.push("Triggering "+b+", "+j.length+" registered.");
for(var h=0;h<j.length;h+=1){var n=j[h];n.method.apply(this,[{key:b,handlerData:n.handlerData,eventData:i}])}}};b.once=function(g,f,j){var h=function(j){f(j);b.unregister(g,h)};b.register(g,h,j)};return b};var instantTempParams=function(b,f,g,i,j,h){return"<?xml version='1.0' encoding='UTF-8'?>    <InstantiateVAppTemplateParams       xmlns='http://www.vmware.com/vcloud/v1.5'       name='"+b+"'       deploy='"+(null==h?!1:h)+"'       powerOn='"+(null==h?!1:h)+"'       xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'       xmlns:ovf='http://schemas.dmtf.org/ovf/envelope/1'>       <Description>"+f+"</Description>       <InstantiationParams>"+(i?"          <NetworkConfigSection>             <ovf:Info>Configuration parameters for logical networks             </ovf:Info>             <NetworkConfig                networkName='"+
g+"'>                <Configuration>                   <ParentNetwork                      href='"+i+"' />                   <FenceMode>bridged</FenceMode>                </Configuration>             </NetworkConfig>          </NetworkConfigSection>":"")+"</InstantiationParams>       <Source          href='"+j+"' />    </InstantiateVAppTemplateParams>"};function Metadata(b){var f=0,g={},i={register:function(e,a){g[e]=a}},j=function(e,a,b){vmware.rest.get(e).done(function(e){e=b($.parseXML(e.xml?e.xml:(new XMLSerializer).serializeToString(e)));if(g[a])g[a](e);delete g[a]})},h=function(e){for(var a={},e=e.getElementsByTagName("MetadataEntry"),b=0;b<e.length;b++)a[e[b].getElementsByTagName("Key")[0].childNodes[0].nodeValue]=e[b].getElementsByTagName("Value")[0].childNodes[0].nodeValue;return a},n=function(e){for(var a={},e=0!=e.getElementsByTagName("VAppRecord").length?
e.getElementsByTagName("VAppRecord"):e.getElementsByTagName("VAppTemplateRecord"),b=0;b<e.length;b++)a[e[b].getAttribute("href")]=e[b].getElementsByTagName("Value")[0].childNodes[0].nodeValue;return a};i.get=function(e){var a=f++;j(e.getHref()+"/metadata",a,h);return a};i.filterTemplates=function(e){var a=f++;j(b.concat("query?type=vAppTemplate&fields=metadata:"+e+"&filter=metadata:"+e+"=ge=NUMBER:0"),a,n);return a};i.filterVApps=function(e){var a=f++;j(b.concat("query?type=vApp&fields=metadata:"+
e+"&filter=metadata:"+e+"=ge=NUMBER:0"),a,n);return a};i.set=function(e,a,b){var h=f++,e=e.getHref()+"/metadata",a='<Metadata            xmlns="http://www.vmware.com/vcloud/v1.5"            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"            type="application/vnd.vmware.vcloud.metadata+xml">                <MetadataEntry                    type="application/vnd.vmware.vcloud.metadata.value+xml">                        <Key>'+a+'</Key>                        <TypedValue                            xsi:type="Metadata'+
(typeof b).substring(0,1).toUpperCase()+(typeof b).substr(1)+'Value">                                <Value>'+b+"</Value>                        </TypedValue>                </MetadataEntry>        </Metadata>";vmware.rest.addHeader("Content-Type","application/vnd.vmware.vcloud.metadata+xml");vmware.rest.post(e,a).done(function(){if(g[h])g[h](void 0);delete g[h]});return h};return i};function vObj(){this.cloud=null;this.zfavorite=!1;this.STATUS_ON=0;this.STATUS_OFF=1;this.STATUS_WORKING=2;this.STATUS_SUSPENDED=3;this.STATUS_ERROR=4;this.STATUS_PARTIAL=5;this.addChild=function(b){this.children.push(b)};this.setAttr=function(b,f){this.attr[b]=f};this.getAttr=function(b){return this.attr[b]};this.addLink=function(b,f){this.links[b]=f};this.getID=function(){return this.attr.id};this.getName=function(){return this.attr.name};this.getHref=function(){return this.attr.href};this.save=
function(){return{attr:this.attr,links:this.links,children:this.children,favorite:this.zfavorite}};this.load=function(b){this.attr=b.attr||this.attr;this.links=b.links||this.links;this.children=b.children||this.children;this.zfavorite=b.favorite||this.zfavorite};this.favorite=function(b){null!=b&&(this.zfavorite=b);return this.zfavorite};this.getDescription=function(){return this.attr.description};this.getStatusMessage=function(){switch(this.getStatus()){case this.STATUS_ON:return localizer.get("STATUS_ON");
case this.STATUS_OFF:return localizer.get("STATUS_OFF");case this.STATUS_ERROR:return localizer.get("STATUS_ERROR");case this.STATUS_WORKING:return localizer.get("STATUS_WORKING");case this.STATUS_PARTIAL:return localizer.get("STATUS_PARTIAL");case this.STATUS_SUSPENDED:return localizer.get("STATUS_SUSPENDED")}};this.isVM=function(){return null!=this.attr.guestOS};this.canPowerOn=function(){return-1!=[this.STATUS_OFF,this.STATUS_PARTIAL,this.STATUS_SUSPENDED].indexOf(this.getStatus())&&null!=this.links["power:powerOn"]};
this.canPowerOff=function(){return-1!=[this.STATUS_ON,this.STATUS_PARTIAL,this.STATUS_SUSPENDED].indexOf(this.getStatus())&&null!=this.links["power:powerOff"]};this.canSuspend=function(){return this.getStatus()==this.STATUS_ON&&null!=this.links["power:suspend"]};this.powerOn=function(){return this.cloud.powerOn(this.getID())};this.powerOff=function(){return this.cloud.powerOff(this.getID())};this.suspend=function(){return this.cloud.suspend(this.getID())}}vApp.prototype=new vObj;
vApp.prototype.constructor=vApp;
function vApp(b){this.cloud=b;this.children=[];this.attr={};this.links={};this.searchTerm=function(){return this.attr.searchTerm};this.getNumberOfVMs=function(){return this.children.length};this.getOwnerName=function(){return this.attr.ownerName};this.getCreationDate=function(){return this.attr.creationDate};this.getChildren=function(){return this.children.map(b.getVM)};this.canDelete=function(){return null!=this.links.remove};this.getVDCName=function(){return this.attr.vdcName};this.edit=function(f,
g){return b.editVApp(this.getID(),f,g)};this.getStatus=function(){for(var b=this.cloud.taskManager.inProgress(),g=0;g<b.length;g++)if(-1!=this.getID().indexOf(b[g]))return this.STATUS_WORKING;for(var b=0,i=this.children.length,j=this.getChildren(),g=0;g<j.length;g++)switch(stat=j[g].getStatus(),stat){case this.STATUS_ON:b++;break;case this.STATUS_SUSPENDED:b+=3.1415;break;case this.STATUS_ERROR:return this.STATUS_ERROR}g=3.1415*i;switch(b){case 0:return this.STATUS_OFF;case i:return this.STATUS_ON;
case g:return this.STATUS_SUSPENDED;default:return this.STATUS_PARTIAL}}}vM.prototype=new vObj;vM.prototype.constructor=vM;
function vM(b){this.cloud=b;this.children=[];this.attr={};this.links={};this.consoleThumbnail="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAwCAIAAAAuKetIAAAAH0lEQVRoge3BAQEAAACCIP+vbkhAAQAAAAAAAAAALwYkMAABjuvAZwAAAABJRU5ErkJggg==";this.getStatus=function(){return 4==this.attr.status?this.STATUS_ON:8==this.attr.status?this.STATUS_OFF:3==this.attr.status?this.STATUS_SUSPENDED:this.STATUS_ERROR};this.getGuestOS=function(){return this.attr.guestOS};this.getNetwork=function(){return this.attr.network};
this.getIP=function(){return this.attr.ip};this.updateConsoleThumbnail=function(){return this.consoleThumbnail};this.getConsoleTicket=function(){var b=this.links["screen:acquireTicket"];if(void 0==b)return console.log("Unable to open console. The VM should be powered-on."),!1;this.cloud.fetchURL(b,"POST","",function(b){var b=b.getElementsByTagName("ScreenTicket")[0].childNodes[0].nodeValue,f;f=(f=/mks:\/\/([^\/]*)\/([^\?]*)\?ticket=(.*)/.exec(b))?{host:f[1],moid:f[2],ticket:unescape(f[3])}:!1;console.log("vCD ScreenTicket: "+
b);this.cloud.fetchURL("https://"+f.host+":9443/sdk","SOAP","*/*",function(){console.log("Host ticket fetched")},'<CloneSession xmlns="urn:vim25"><_this type="SessionManager">SessionManager</_this><cloneTicket xsi:type="xsd:string">'+f.ticket+"</cloneTicket></CloneSession>")})}}
function Template(){this.attr={searchTerm:""};this.xml="";this.setAttr=function(b,f){this.attr[b]=f};this.getAttr=function(b){return this.attr[b]};this.save=function(){return{attr:this.attr}};this.load=function(b){this.attr=b.attr||this.attr};this.getHref=function(){return this.getAttr("href")};this.getName=function(){return this.getAttr("name")};this.getDescription=function(){return this.getAttr("description")};this.getDownloads=function(){return this.getAttr("downloads")};this.getNetwork=function(){return this.getAttr("network")};
this.getChildren=function(){return this.getAttr("childNames")};this.getOwnerName=function(){return this.getAttr("owner")};this.getCatalogName=function(){return this.getAttr("catalog")};this.getCPUMhz=function(){return this.getAttr("cpu")};this.getMemoryMB=function(){return this.getAttr("memory")};this.getStorageKB=function(){return this.getAttr("storage")}};vmware="undefined"==typeof vmware||!vmware?{}:vmware;
vmware.rest=function(){var b={},f={},g=function(g,f,i){return $.ajax(f,{type:g,headers:b,dataType:i||"xml"})},i=function(g,f,i,e){return $.ajax(f,{type:g,data:i,headers:b,dataType:e||"xml"})};f.dataType="xml";f.addHeader=function(g,f){b[g]=f};f.hasHeader=function(g){return null!=b[g]};f.removeHeader=function(g){delete b[g]};f.removeAllHeaders=function(){b={}};f.get=function(b){return g("GET",b)};f.postGetJSON=function(b,f){return f?i("POST",b,f,"json"):g("POST",b,"json")};f.post=function(b,f){return f?
i("POST",b,f):g("POST",b)};f.put=function(b,f){return f?i("PUT",b,f):g("PUT",b)};f.del=function(b){return g("DELETE",b)};return f}();vmware="undefined"==typeof vmware||!vmware?{}:vmware;
vmware.soap=function(){var b={};return{dataType:"xml",addHeader:function(f,g){b[f]=g},hasHeader:function(f){return null!=b[f]},removeHeader:function(f){delete b[f]},removeAllHeaders:function(){b={}},post:function(f,g){return $.ajax(f,{type:"POST",data:'<?xml version="1.0" encoding="UTF-8"?><soapenv:Envelope xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsd="http:/www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><soapenv:Body>'+g+
"</soapenv:Body></soapenv:Envelope>",headers:b,dataType:"xml",cache:!1})}}}();function TaskManager(b){var f,g={},i={},j=function(){this.attr={}};j.prototype.addAttr=function(b,a){this.attr[b]=a};var h={autoRefresh:null,update:function(){clearTimeout(f);var e=!1;for(key in g)b.fetchURL(g[key].attr.href,"GET",null,h.refreshTask),e=!0;h.autoRefresh&&h.autoRefresh(h.loadTasks);f=e?setTimeout(function(){h.update()},5E3):setTimeout(function(){h.update()},1E4)},loadTasks:function(b){h.loadTasksTo(g)(b)},loadTasksLog:function(b){h.loadTasksTo(i)(b)},loadTasksTo:function(b){return function(a){var g,
f;for(f=0;f<a.getElementsByTagName("TaskRecord").length;f++){g=new j;for(var h=a.getElementsByTagName("TaskRecord")[f],i=0;i<h.attributes.length;i++)g.addAttr(h.attributes[i].name,h.attributes[i].value);b[g.attr.href]=g}}},newTask:function(e){h.refreshTask(e);b.trigger(vmware.events.cloud.TASK_START)},refreshTask:function(e){for(var a=new j,f=e.getElementsByTagName("Task")[0],p=0;p<f.attributes.length;p++)a.addAttr(f.attributes[p].name,f.attributes[p].value);0!=e.getElementsByTagName("Link").length&&
a.addAttr("cancel",e.getElementsByTagName("Link")[0].getAttribute("href"));a.addAttr("ownerHref",e.getElementsByTagName("Owner")[0].getAttribute("href"));a.addAttr("user",e.getElementsByTagName("User")[0].getAttribute("name"));0!=e.getElementsByTagName("Progress").length&&a.addAttr("progress",e.getElementsByTagName("Progress")[0].childNodes[0].data);null==i[a.attr.href]&&("success"==a.attr.status?(f={success:!0,data:a},i[a.attr.href]=a,-1!=a.attr.ownerHref.match("vapp")&&h.addFakeTask(a.attr.ownerHref),
delete g[a.attr.href],null==a.attr.progress&&null==a.attr.name.match("elete")&&null==a.attr.operationName.match("elete")?b.trigger(vmware.events.cloud.TASK_COMPLETE,f):b.updateModels()):"error"==a.attr.status?(f={success:!1,data:a},message=e.getElementsByTagName("Error")[0].getAttribute("message")||(e.getElementsByTagName("Details")[0].childNodes[0]?e.getElementsByTagName("Details")[0].childNodes[0].data:null),a.addAttr("error",message),i[a.attr.href]=a,delete g[a.attr.href],b.trigger(vmware.events.cloud.TASK_COMPLETE,
f)):g[a.attr.href]=a)},numberOfTasks:function(){return h.inProgress().length},saveLog:function(){return i},loadLog:function(b){i=b},details:function(b){return task=null==g[b]?i[b]:g[b]},taskLog:function(){for(var b=[],a=[i,g],f={},h=0;h<a.length;h++)for(key in a[h])f[key]=a[h][key];for(key in f)b.push([null!=f[key].attr.ownerName?f[key].attr.ownerName:f[key].attr.user,n("task"!=f[key].attr.name?f[key].attr.name:f[key].attr.operationName),null!=f[key].attr.startDate?f[key].attr.startDate:f[key].attr.startTime,
f[key].attr.status,key]);return b.sort(function(a,b){return a[2]>b[2]?-1:a[2]<b[2]?1:0})}},n=function(b){var a={poweron:localizer.get("TASK_POWERING_ON"),poweroff:localizer.get("TASK_POWERING_OFF"),acquirescreen:localizer.get("TASK_CONSOLE"),suspend:localizer.get("TASK_SUSPEND"),instantiate:localizer.get("TASK_CREATE_VAPP"),"delete":localizer.get("TASK_DELETE"),jobundeploy:localizer.get("TASK_UNDEPLOY_VAPP"),jobdeploy:localizer.get("TASK_DEPLOY_VAPP"),vappundeploy:localizer.get("TASK_UNDEPLOY_VAPP"),
vappdeploy:localizer.get("TASK_DEPLOY_VAPP"),update:localizer.get("TASK_EDIT_VAPP"),uploadovf:localizer.get("TASK_UPLOAD_OVF")},f;for(f in a)if(null!=b.toLowerCase().match(f))return a[f];return b};h.tasksPerHour=function(){hours=[];count=0;tl=h.taskLog();for(var b=0;b<tl.length;b++)newdate=new Date(tl[b][2]),(0==hours.length||36E5<hours[hours.length-1]-newdate)&&hours.push(newdate);return tl.length/hours.length};h.tasks=function(){return g};h.fakeTasks={};h.addFakeTask=function(e){h.fakeTasks[e]=
1;b.trigger(vmware.events.cloud.REFRESH_SINGLE,{vapp:b.getVAppFromHref(e),dontdeleteplease:1})};h.inProgress=function(){var b=[];for(key in g)g[key].attr.ownerHref&&b.push(g[key].attr.ownerHref.split("/")[g[key].attr.ownerHref.split("/").length-1].split("-").slice(1).join("-"));for(key in h.fakeTasks)b.push(key.split("/")[key.split("/").length-1].split("-").slice(1).join("-"));return b};h.update();b.register(vmware.events.cloud.REFRESH_COMPLETE,function(){h.fakeTasks={}});b.register(vmware.events.cloud.REFRESH_SINGLE,
function(e){null==e.eventData.dontdeleteplease&&(h.fakeTasks={},e.eventData.dontdeleteplease=1,b.trigger(vmware.events.cloud.REFRESH_SINGLE,e.eventData))});return h};localizer={lang:0,languages:{EN:0},setlang:function(b){lang=b;this[lang]||(this[lang]={});return this},add:function(b,f){this[lang][b]=f;return this},get:function(b){return this[lang]?this[lang][b]:b}};
localizer.setlang(localizer.languages.EN).add("SYSTEM_NOT_SUPPORTED","You are attempting to connect to a system no longer supported.").add("LOST_CONNECTIVITY","You seem to have lost connectivity - your changes will not be saved until connectivity is reestablished.").add("STATUS_ON","Powered On").add("STATUS_OFF","Powered Off").add("STATUS_ERROR","Error!").add("STATUS_WORKING","Working...").add("STATUS_PARTIAL","Partially On").add("STATUS_SUSPENDED","Suspended").add("TASK_POWERING_ON","Powering On").add("TASK_POWERING_OFF",
"Powering Off").add("TASK_CONSOLE","Connecting To Console").add("TASK_SUSPEND","Suspending").add("TASK_CREATE_VAPP","Creating vApp").add("TASK_DELETE","Deleting").add("TASK_UNDEPLOY_VM","Undeploying VM").add("TASK_DEPLOY_VM","Deploying VM").add("TASK_UNDEPLOY_VAPP","Undeploying vApp").add("TASK_DEPLOY_VAPP","Deploying vApp").add("TASK_EDIT_VAPP","Editing vApp").add("TASK_UPLOAD_OVF","Uploading OVF");
